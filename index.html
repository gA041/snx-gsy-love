<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>snx gsy æ°¸è¿œåœ¨ä¸€èµ· Â· å…±äº«èŠå¤©å¢™</title>
    <!-- å¼•å…¥ LeanCloud SDK (ä¸ä¹‹å‰ç›¸åŒ) -->
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.13.2/dist/av-min.js"></script>
    <style>
        /* ===== æ‚¨çš„åŸæœ‰æ ·å¼ å®Œå…¨ä¿ç•™ (åªå¾®è°ƒäº†modalé˜²æ­¢é‡å ) ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", "Segoe UI", sans-serif;
        }

        body {
            position: relative;
            background-image: url("gsy666.jpg");
            background-size: 80% auto;
            background-position: center center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
            -webkit-backface-visibility: hidden;
            min-height: 100vh;
            color: #fff;
            overflow-x: hidden;
            padding-bottom: 80px;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0);
            z-index: -1;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.7rem 1rem;
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
        }
        .top-bar .title {
            font-family: 'Georgia', serif;
            font-size: 1.3rem;
            color: #f8c8d8;
            letter-spacing: 1px;
        }
        .top-bar .info {
            font-size: 0.8rem;
            color: #ddd;
        }

        .song-info {
            text-align: center;
            padding: 1rem 1rem;
        }
        .song-title {
            font-size: 1.5rem;
            color: #f8c8d8;
            margin-bottom: 0.5rem;
        }
        .song-artist {
            font-size: 1rem;
            color: #ccc;
        }

        .extra-title {
            text-align: center;
            font-size: 1.8rem;
            color: #f8c8d8;
            margin: 0.5rem 0;
            font-weight: bold;
        }

        .progress {
            width: 80%;
            margin: 0 auto 1rem;
            height: 6px;
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
            position: relative;
        }
        .progress-bar {
            width: 35%;
            height: 100%;
            background: #f8c8d8;
            border-radius: 3px;
        }
        .progress-dot {
            position: absolute;
            top: 50%;
            left: 35%;
            transform: translate(-50%, -50%);
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #f8c8d8;
        }
        .time {
            display: flex;
            justify-content: space-between;
            width: 80%;
            margin: 0 auto;
            font-size: 0.9rem;
            color: #ccc;
        }

        .listen-together {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.8rem;
            margin: 1.5rem 0;
            position: relative;
        }
        .avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.6rem;
            border: 2px solid #f8c8d8;
        }
        .heart {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #f8c8d8;
            font-size: 1.3rem;
        }
        .headphone-icon {
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1rem;
        }

        .main-buttons {
            display: flex;
            gap: 1.5rem;
            justify-content: center;
            margin: 2rem 0 0.8rem 0;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .secondary-buttons {
            display: flex;
            justify-content: center;
            margin: 0.5rem 0 1rem 0;
        }
        
        .btn-large {
            padding: 0.8rem 2.5rem;
            font-size: 1.2rem;
            border: none;
            border-radius: 12px;
            background-color: #f8c8d8;
            color: #222;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
        }
        .btn-large:hover {
            background-color: #f5a7bc;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(248, 200, 216, 0.3);
        }
        
        .btn-small {
            padding: 0.4rem 1.2rem;
            font-size: 0.9rem;
            border: none;
            border-radius: 20px;
            background-color: rgba(248,200,216,0.3);
            backdrop-filter: blur(5px);
            border: 1px solid #f8c8d8;
            color: #fff;
            font-weight: 500;
            cursor: pointer;
            transition: 0.3s;
            letter-spacing: 0.5px;
        }
        .btn-small:hover {
            background-color: #f8c8d8;
            color: #222;
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(248, 200, 216, 0.2);
        }

        .chat {
            width: 90%;
            max-width: 600px;
            margin: 2rem auto;
            max-height: 420px;
            overflow-y: auto;
            display: block;
            background: transparent;
            padding: 0.5rem;
        }

        .history-container {
            margin-bottom: 1rem;
            border-bottom: 1px solid rgba(248,200,216,0.3);
            padding-bottom: 0.5rem;
        }

        .history-toggle-btn {
            background: rgba(248,200,216,0.2);
            border: 1px solid #f8c8d8;
            color: #f8c8d8;
            padding: 0.3rem 1rem;
            border-radius: 30px;
            font-size: 0.8rem;
            cursor: pointer;
            backdrop-filter: blur(4px);
            transition: 0.2s;
            margin-bottom: 0.8rem;
            display: inline-block;
            width: auto;
        }
        .history-toggle-btn:hover {
            background: #f8c8d8;
            color: #222;
        }

        #messageHistory {
            display: block;
            margin-top: 0.5rem;
        }
        #messageHistory.hidden {
            display: none;
        }

        .message-item {
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            border-radius: 18px;
            padding: 0.7rem 1.2rem;
            margin-bottom: 0.8rem;
            color: #fff;
            font-size: 1rem;
            border: 1px solid rgba(248,200,216,0.2);
            word-break: break-word;
            text-shadow: 0 0 2px #000;
        }
        .message-item small {
            display: block;
            font-size: 0.7rem;
            color: #f8c8d8;
            margin-top: 0.3rem;
            opacity: 0.8;
        }
        .message-item.own {
            border-left: 3px solid #f8c8d8;
        }
        /* å¯¹æ–¹æ¶ˆæ¯æ˜¾ç¤ºä¸åŒæ ‡è®°ï¼Œä½†éƒ½ä¿ç•™åœ¨å†å²é‡Œ */
        .message-item.other {
            border-left: 3px solid #a0d8f0;
        }

        .bubble {
            width: 100%;
            padding: 1rem;
            font-size: 1rem;
            line-height: 1.7;
            color: #fff;
            text-shadow: 0 0 4px #000;
            display: none;
            margin-top: 1rem;
            border-top: 1px solid rgba(248,200,216,0.2);
        }

        .chat::-webkit-scrollbar {
            width: 6px;
        }
        .chat::-webkit-scrollbar-thumb {
            background: #f8c8d8;
            border-radius: 3px;
        }

        .sudoku-section {
            width: 90%;
            max-width: 340px;
            margin: 1.5rem auto 2rem;
            background: rgba(10, 10, 20, 0.5);
            backdrop-filter: blur(8px);
            border-radius: 22px;
            padding: 1rem 0.6rem;
            box-shadow: 0 8px 20px rgba(0,0,0,0.5);
            border: 1px solid rgba(248,200,216,0.3);
            transition: opacity 0.3s ease;
        }
        .sudoku-section.hidden-sudoku {
            display: none;
        }

        .sudoku-title {
            text-align: center;
            font-size: 1.2rem;
            color: #f8c8d8;
            margin-bottom: 0.3rem;
            letter-spacing: 1px;
            font-weight: 300;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            user-select: none;
        }
        .sudoku-title span {
            font-size: 0.8rem;
            background: #f8c8d8;
            color: #222;
            padding: 0.1rem 0.8rem;
            border-radius: 30px;
            font-weight: 500;
        }
        .sudoku-grid {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            gap: 0;
            background-color: rgba(255,255,255,0.15);
            padding: 0;
            border: 2px solid #f8c8d8;
            border-radius: 10px;
            margin: 0.5rem 0 0.8rem;
            overflow: hidden;
        }
        .sudoku-cell {
            aspect-ratio: 1 / 1;
            background: rgba(30, 30, 40, 0.8);
            border: 1px solid rgba(248,200,216,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: 500;
            color: #f0d0e0;
            caret-color: #f8c8d8;
            transition: 0.1s;
            text-align: center;
            box-sizing: border-box;
        }
        .sudoku-cell.right-border {
            border-right: 2px solid #f8c8d8;
        }
        .sudoku-cell.bottom-border {
            border-bottom: 2px solid #f8c8d8;
        }
        .sudoku-cell.prefilled {
            color: #ffcfcf;
            background: rgba(60, 40, 50, 0.7);
            font-weight: 600;
            text-shadow: 0 0 6px #f8c8d8;
        }
        .sudoku-cell[contenteditable="true"]:focus {
            outline: 2px solid #f8c8d8;
            outline-offset: -1px;
            background: rgba(80, 60, 70, 0.9);
            color: #fff;
            z-index: 1;
            position: relative;
        }
        .sudoku-controls {
            display: flex;
            justify-content: center;
            gap: 0.6rem;
            margin-top: 0.5rem;
            flex-wrap: wrap;
        }
        .sudoku-btn {
            background: rgba(248,200,216,0.2);
            border: 1px solid #f8c8d8;
            color: #f8c8d8;
            padding: 0.25rem 1rem;
            border-radius: 30px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            backdrop-filter: blur(4px);
            transition: 0.2s;
            min-width: 60px;
        }
        .sudoku-btn:hover {
            background: #f8c8d8;
            color: #222;
            border-color: #f8c8d8;
        }
        .sudoku-message {
            text-align: center;
            font-size: 0.8rem;
            margin-top: 0.5rem;
            color: #f0c0d0;
            min-height: 1.4rem;
        }

        .input-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            display: flex;
            align-items: center;
            padding: 0.8rem 1rem;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(10px);
            z-index: 99;
        }
        .input-bar input {
            flex: 1;
            padding: 0.8rem 1.2rem;
            border-radius: 20px;
            border: none;
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-size: 1rem;
        }
        .input-bar input::placeholder {
            color: #999;
        }
        .input-bar .icons {
            display: flex;
            gap: 1.5rem;
            margin-left: 1rem;
            font-size: 1.2rem;
            cursor: pointer;
            user-select: none;
        }
        .input-bar .icons span:last-child {
            color: #f8c8d8;
            font-weight: bold;
        }

        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            padding: 2rem 3rem;
            border-radius: 16px;
            z-index: 1000;
            color: #222;
            text-align: center;
        }
        .overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
    </style>
</head>
<body>

    <audio id="bgm" loop autoplay playsinline webkit-playsinline>
        <source src="https://music.163.com/song/media/outer/url?id=209397.mp3" type="audio/mpeg">
    </audio>

    <div class="top-bar">
        <div>
            <span>ğŸ¾</span>
            <span style="margin-left: 1rem;">âœ¨</span>
        </div>
        <div class="title">we got one love</div>
        <div class="info">ä¸€èµ·å¬ â™¡ æ—¶é•¿: 20:21</div>
    </div>

    <div class="song-info">
        <div class="song-title">å¯çˆ±å¥³äºº</div>
        <div class="song-artist">å‘¨æ°ä¼¦</div>
    </div>

    <div class="extra-title">2021 4ever</div>

    <div class="progress">
        <div class="progress-bar"></div>
        <div class="progress-dot"></div>
    </div>
    <div class="time">
        <span>00:20</span>
        <span>00:21</span>
    </div>

    <div class="listen-together">
        <div class="headphone-icon"> </div>
        <div class="avatar">ğŸ¾</div>
        <div class="heart">ğŸ’</div>
        <div class="avatar">ğŸˆ</div>
    </div>

    <div class="main-buttons">
        <button id="yesBtn" class="btn-large">yes</button>
        <button id="noBtn" class="btn-large">no</button>
    </div>
    
    <div class="secondary-buttons">
        <button id="sudokuToggleBtn" class="btn-small">ğŸ‘ç»™è€å©†è§£é—·</button>
    </div>

    <div class="chat" id="chat">
        <div class="history-container">
            <span id="historyToggleBtn" class="history-toggle-btn">çœ‹çœ‹éƒ½è¯´äº†äº›å•¥</span>
            <div id="messageHistory" class="hidden"></div>
        </div>
        
        <div class="bubble" id="longMessage">
å®å® å’Œä½ åœ¨ä¸€èµ·çš„æ—¥å­æ€»æ˜¯è¿™ä¹ˆå¹¸ç¦ä¸”çŸ­æš‚ å’Œä½ è§é¢å¾ˆå¼€å¿ƒåˆå¾ˆéš¾è¿‡ æ¯æ¬¡æ´—æ¼±å®Œå‡ºæ¥çœ‹åˆ°ä½ éƒ½åœ¨æˆ‘ç¡çš„é‚£ä¸€è¾¹æ”¾å¥½æ°´ æˆ‘å°±æ‹¿èµ·æ‰‹æœºè¾¹çœ‹æ—¥å†è¾¹æƒ³ è¿˜æœ‰å¤šå°‘å¤©å°±åˆè¦å’Œä½ åˆ†å¼€ æˆ‘çˆ¶æ¯æ€»æ˜¯å‘Šè¯‰æˆ‘æˆ‘é•¿å¤§äº†ä¸å¯ä»¥å†é‚£ä¹ˆä¾èµ–åˆ«äºº è¦ç‹¬ç«‹ ä¹Ÿä¸ä¼šæ€ä¹ˆå’Œæˆ‘è¡¨è¾¾æ„Ÿæƒ… äº¤æµä¹Ÿæ˜¯è¶Šæ¥è¶Šå°‘ è®©æˆ‘ä¸€ç›´éƒ½è®¤ä¸ºäººæ˜¯æ¼‚æ³Šçš„å€™é¸Ÿ ç›´åˆ°ä½ å‘Šè¯‰æˆ‘æˆ‘å¯ä»¥å»ä¾èµ–ä½  ä¿¡ä»»ä½  å¤šå’Œä½ è¡¨è¾¾æ„Ÿå— æˆ‘åˆè§‰å¾—çˆ±æ˜¯å¯ä»¥å®œå±…çš„å°å²› æœ‰ä¸€ç§ æˆ‘è§ä¼—ç”Ÿçš†è‰æœ¨ å”¯ç‹¬è§ä½ æ˜¯é’å±±çš„æ„Ÿè§‰ ä½ ä¹Ÿæ€»æ˜¯å¾ˆç…§é¡¾æˆ‘ è™½ç„¶æˆ‘ä¼šè«åå…¶å¦™è·Ÿä½ ç”Ÿä¸€äº›å°æ°” ä½†ä½ éƒ½ä¼šè¯´æ˜¯ä½ çš„é”™ åŒ…å®¹æˆ‘ è¿™äº›éƒ½æ˜¯æˆ‘ä»æœªä½“éªŒè¿‡çš„ æˆ‘æ€»è¯´æˆ‘ä¸ä¿¡ä»»ä½  ä¸æ˜¯ä½ åšçš„ä¸å¤Ÿå¥½ æ˜¯æˆ‘æ€•ä¿¡ä»»ä½ ä¾èµ–ä½ ä¹‹åå¦‚æœä½ ä¸å–œæ¬¢æˆ‘äº†æˆ‘åˆè¦å˜å›åŸæ¥çš„æ ·å­ é‚£æˆ‘è¦æ€ä¹ˆä¹ æƒ¯ ä½†ä½ å¥½åƒæ‹¥æœ‰ä»€ä¹ˆé­”æ³• è®©æˆ‘å¯ä»¥ä¸€ç‚¹ç‚¹å‘ä½ æ‘Šå‘ˆè‡ªå·± ä¹Ÿè®©ä½ çœ‹åˆ°æˆ‘çš„è„†å¼± çœ¼æ³ª è¿˜æœ‰ä¸€äº›ä¸å®Œç¾çš„é‚£é¢ ä½†çœŸè¯šçš„ è°¢è°¢ä½ çš„å­˜åœ¨ æœ‰ä½ åœ¨æˆ‘æ€»ä¼šå¾ˆå®‰å¿ƒ  é€ä½ å»é«˜é“ç«™æˆ‘æƒ³è®©ä½ å¿«ç‚¹è¿›å» è¿™æ ·æˆ‘å°±ä¸ä¼šé‚£ä¹ˆèˆä¸å¾—ä½  è€Œæˆ‘ç°åœ¨èƒ½ç»™ä½ çš„åˆå¤ªå°‘ å†ç»™æˆ‘ä¸€ç‚¹æ—¶é—´ ä»¥åä¸€å®šèƒ½ç»™ä½  æˆ‘å‘èª“ æˆ‘ä¸æ˜¯å¾ˆä¼šè¡¨è¾¾è¿™äº›æƒ…æƒ…è¯è¯çš„ä¸œè¥¿ ä½†çœŸå¿ƒå¸Œæœ›ä½ å¥½ æˆ‘ä»¬äº’ç›¸åŠ æ²¹å˜æˆæ›´å¥½çš„è‡ªå·±

å±±é«˜è·¯è¿œ ä¸€è·¯å¹³å®‰  ä¸€ä¸ªäººåœ¨å›½å¤–ç…§é¡¾å¥½è‡ªå·± è™½ç„¶æ¯æ¬¡æˆ‘è¯´è¿™å¥è¯ ä½ éƒ½è¯´ä½ å·²ç»ä¼šå¾ˆå¥½çš„ç…§é¡¾è‡ªå·±äº† ä½†æƒ³åˆ°ä½ ä¸€ä¸ªäººé¢å¯¹é‚£äº›  ä¸€ä¸ªäººæ‹–è¡Œæ è½åœ°è¦ä»æœºåœºåé‚£ä¹ˆä¹…çš„è½¦æ‰èƒ½åˆ°å®¶ ä¹Ÿå¾ˆä¸å®¹æ˜“ æˆ‘å¿ƒç–¼ä½  åšé¥­çš„æ—¶å€™å°å¿ƒä¸è¦çƒ«åˆ° èµ°è·¯è¦æ…¢æ…¢èµ° å°å¿ƒä¸è¦ç£•ç£•ç¢°ç¢° å¤šå–çƒ­æ°´ è¦å°‘åƒè¤ªé»‘ç´   ä¸è¦ç€å‡‰ä¸è¦ç”Ÿç—…ï¼æˆ‘çˆ±ä½  è¦å¤šå¤šæƒ³æˆ‘ ä¸å¯ä»¥å“­å“­å™¢  å¤šç¬‘ç¬‘
        </div>
    </div>

    <div class="sudoku-section hidden-sudoku" id="sudokuSection">
        <div class="sudoku-title">
            ğŸ‘æ¯æ—¥ä¸€ç»ƒ<span>snxåŠ æ²¹</span>
        </div>
        <div id="sudokuGrid" class="sudoku-grid"></div>
        <div class="sudoku-controls">
            <button class="sudoku-btn" id="checkSudoku">æ£€æŸ¥</button>
            <button class="sudoku-btn" id="resetSudoku">é‡ç½®</button>
            <button class="sudoku-btn" id="newSudoku">æ–°é¢˜</button>
        </div>
        <div id="sudokuMessage" class="sudoku-message">å¡«å…¥æ•°å­— 1-9ï¼Œæ¯è¡Œ/åˆ—/å®«ä¸é‡å¤</div>
    </div>

    <div class="input-bar">
        <input type="text" id="messageInput" placeholder="è¯´ç‚¹ä»€ä¹ˆ...">
        <div class="icons">
            <span>yeobo</span>
            <span>i</span>
            <span id="sendMsgBtn" style="cursor: pointer;">xin</span>
        </div>
    </div>

<script>
    // ===== æ‰€æœ‰åŸæœ‰é€»è¾‘ä¿ç•™ (yes/no/éŸ³é¢‘/æ¨¡æ€æ¡†/æ•°ç‹¬) =====
    const longMsg = document.getElementById('longMessage');
    const yesBtn = document.getElementById('yesBtn');
    const noBtn = document.getElementById('noBtn');

    yesBtn.onclick = function() {
        if (longMsg.style.display === 'block') {
            longMsg.style.display = 'none';
        } else {
            longMsg.style.display = 'block';
        }
        playAudio();
    };

    noBtn.onclick = function() {
        playAudio();
        showModal('æ²¡æœ‰é€‰noçš„æœºä¼šå“¦ â™¾ï¸', true);
    };

    function showModal(message, showButtons) {
        const overlay = document.createElement('div');
        overlay.className = 'overlay';
        document.body.appendChild(overlay);

        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `<p>${message}</p >`;

        if (showButtons) {
            const btnContainer = document.createElement('div');
            btnContainer.style.display = 'flex';
            btnContainer.style.gap = '1rem';
            btnContainer.style.justifyContent = 'center';
            btnContainer.style.marginTop = '1rem';

            const btn1 = document.createElement('button');
            btn1.innerText = 'yes';
            const btn2 = document.createElement('button');
            btn2.innerText = 'yes';

            const handleBtnClick = () => {
                alert('æ­å–œsnxæ°¸è¿œçˆ±æˆ‘ ğŸ’');
                clearModals();
            };

            btn1.onclick = handleBtnClick;
            btn2.onclick = handleBtnClick;

            btnContainer.appendChild(btn1);
            btnContainer.appendChild(btn2);
            modal.appendChild(btnContainer);
        }

        document.body.appendChild(modal);
    }

    function clearModals() {
        document.querySelectorAll('.overlay').forEach(el => el.remove());
        document.querySelectorAll('.modal').forEach(el => el.remove());
    }

    const audio = document.getElementById('bgm');
    audio.src = "https://music.163.com/song/media/outer/url?id=209397.mp3";

    let played = false;
    function playAudio() {
        if (played) return;
        audio.play()
            .then(() => {
                played = true;
                document.removeEventListener('touchstart', playAudio);
                document.removeEventListener('click', playAudio);
            })
            .catch(() => {});
    }

    document.addEventListener('touchstart', playAudio, { once: true });
    document.addEventListener('click', playAudio, { once: true });

    audio.load();

    // æ•°ç‹¬æ¸¸æˆé€»è¾‘
    const PUZZLE_EASY = [
        [5,3,0,0,7,0,0,0,0],
        [6,0,0,1,9,5,0,0,0],
        [0,9,8,0,0,0,0,6,0],
        [8,0,0,0,6,0,0,0,3],
        [4,0,0,8,0,3,0,0,1],
        [7,0,0,0,2,0,0,0,6],
        [0,6,0,0,0,0,2,8,0],
        [0,0,0,4,1,9,0,0,5],
        [0,0,0,0,8,0,0,7,9]
    ];

    let currentBoard = JSON.parse(JSON.stringify(PUZZLE_EASY));
    let initialBoard = JSON.parse(JSON.stringify(PUZZLE_EASY));

    const gridContainer = document.getElementById('sudokuGrid');
    const messageEl = document.getElementById('sudokuMessage');

    function addBoxBorders(cell, row, col) {
        if (col % 3 === 2 && col !== 8) {
            cell.classList.add('right-border');
        }
        if (row % 3 === 2 && row !== 8) {
            cell.classList.add('bottom-border');
        }
    }

    function renderSudoku(board, initial) {
        gridContainer.innerHTML = '';
        for (let r = 0; r < 9; r++) {
            for (let c = 0; c < 9; c++) {
                const cell = document.createElement('div');
                cell.className = 'sudoku-cell';
                addBoxBorders(cell, r, c);
                
                const isPrefilled = initial[r][c] !== 0;
                if (isPrefilled) {
                    cell.classList.add('prefilled');
                    cell.setAttribute('contenteditable', 'false');
                    cell.textContent = initial[r][c];
                } else {
                    cell.setAttribute('contenteditable', 'true');
                    cell.textContent = board[r][c] !== 0 ? board[r][c] : '';
                }
                cell.dataset.row = r;
                cell.dataset.col = c;
                
                cell.addEventListener('input', function(e) {
                    const row = parseInt(this.dataset.row);
                    const col = parseInt(this.dataset.col);
                    let val = this.innerText.trim();
                    const match = val.match(/[1-9]/);
                    if (match) {
                        const digit = match[0];
                        this.innerText = digit;
                        currentBoard[row][col] = parseInt(digit);
                    } else {
                        this.innerText = '';
                        currentBoard[row][col] = 0;
                    }
                });
                
                cell.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.blur();
                    }
                });
                
                gridContainer.appendChild(cell);
            }
        }
    }

    function resetToInitial() {
        currentBoard = JSON.parse(JSON.stringify(initialBoard));
        updateUIFromBoard(currentBoard, initialBoard);
        messageEl.innerText = 'å·²é‡ç½®ï¼ŒåŠ æ²¹è€å©† ğŸ’ª';
    }

    function updateUIFromBoard(board, initial) {
        const cells = document.querySelectorAll('#sudokuGrid .sudoku-cell');
        cells.forEach(cell => {
            const r = parseInt(cell.dataset.row);
            const c = parseInt(cell.dataset.col);
            if (initial[r][c] !== 0) return;
            const val = board[r][c];
            cell.textContent = val !== 0 ? val : '';
        });
    }

    const PUZZLE_MEDIUM = [
        [0,0,0,2,6,0,7,0,1],
        [6,8,0,0,7,0,0,9,0],
        [1,9,0,0,0,4,5,0,0],
        [8,2,0,1,0,0,0,4,0],
        [0,0,4,6,0,2,9,0,0],
        [0,5,0,0,0,3,0,2,8],
        [0,0,9,3,0,0,0,7,4],
        [0,4,0,0,5,0,0,3,6],
        [7,0,3,0,1,8,0,0,0]
    ];

    function loadNewPuzzle() {
        initialBoard = JSON.parse(JSON.stringify(PUZZLE_MEDIUM));
        currentBoard = JSON.parse(JSON.stringify(PUZZLE_MEDIUM));
        renderSudoku(currentBoard, initialBoard);
        messageEl.innerText = 'æ–°é¢˜ç›®æ¥å•¦ï¼ŒåŠ æ²¹è€å©†';
    }

    function isBoardValid(board) {
        const rows = Array(9).fill().map(() => ({}));
        const cols = Array(9).fill().map(() => ({}));
        const boxes = Array(9).fill().map(() => ({}));

        for (let r = 0; r < 9; r++) {
            for (let c = 0; c < 9; c++) {
                const val = board[r][c];
                if (val === 0) continue;
                if (val < 1 || val > 9) return false;
                const boxIdx = Math.floor(r/3)*3 + Math.floor(c/3);
                if (rows[r][val] || cols[c][val] || boxes[boxIdx][val]) return false;
                rows[r][val] = true;
                cols[c][val] = true;
                boxes[boxIdx][val] = true;
            }
        }
        return true;
    }

    function checkSudoku() {
        const cells = document.querySelectorAll('#sudokuGrid .sudoku-cell');
        cells.forEach(cell => {
            const r = parseInt(cell.dataset.row);
            const c = parseInt(cell.dataset.col);
            if (initialBoard[r][c] !== 0) return;
            const txt = cell.innerText.trim();
            if (txt.match(/^[1-9]$/)) {
                currentBoard[r][c] = parseInt(txt);
            } else {
                currentBoard[r][c] = 0;
            }
        });

        let hasEmpty = false;
        outer: for (let r=0; r<9; r++) {
            for (let c=0; c<9; c++) {
                if (currentBoard[r][c] === 0) {
                    hasEmpty = true;
                    break outer;
                }
            }
        }

        if (hasEmpty) {
            messageEl.innerText = 'è¿˜æœ‰ç©ºæ ¼å­ï¼Œå†å¡«å¡«å‘¢å®å®';
            return;
        }

        if (isBoardValid(currentBoard)) {
            messageEl.innerText = 'å®Œç¾ï¼è€å©†å‰å®³ï¼';
        } else {
            messageEl.innerText = 'å¥½åƒæœ‰é‡å¤ï¼Œå†æ£€æŸ¥ä¸€ä¸‹å§å®å®';
        }
    }

    renderSudoku(currentBoard, initialBoard);

    document.getElementById('checkSudoku').addEventListener('click', checkSudoku);
    document.getElementById('resetSudoku').addEventListener('click', resetToInitial);
    document.getElementById('newSudoku').addEventListener('click', function() {
        loadNewPuzzle();
    });

    document.querySelectorAll('#sudokuGrid .sudoku-cell[contenteditable="true"]').forEach(cell => {
        cell.addEventListener('paste', (e) => {
            e.preventDefault();
            const text = (e.clipboardData || window.clipboardData).getData('text');
            const match = text.match(/[1-9]/);
            if (match) {
                cell.innerText = match[0];
                const inputEvent = new Event('input', { bubbles: true });
                cell.dispatchEvent(inputEvent);
            }
        });
    });

    // ===== å…±äº«èŠå¤©æ ¸å¿ƒ â€”â€” æ‰€æœ‰äººå‘çš„æ¶ˆæ¯éƒ½åœ¨å†å²è®°å½•æ˜¾ç¤ºï¼ŒåŒæ–¹å¯è§ =====
    // åˆå§‹åŒ– LeanCloudï¼ˆä¸ä¹‹å‰ç›¸åŒï¼Œå…¬å…±æµ‹è¯•åº”ç”¨ï¼‰
    AV.init({
        appId: '1i4yFOWT6Kt8UXxCEUAdpueP-gzGzoHsz',
        appKey: 'Y5FR3nMBovHBPvMZX5mgbN0h',
        serverURL: 'https://1i4yfowt.lc-cn-n1-shared.com'
    });

    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendMsgBtn');
    const messageHistoryDiv = document.getElementById('messageHistory');
    const historyToggleBtn = document.getElementById('historyToggleBtn');

    let historyVisible = false;  // é»˜è®¤éšè—
    let myLastMessageTime = null; // ç”¨äºå»é‡ï¼ˆå¯é€‰ï¼‰

    // æ¶ˆæ¯è¡¨ (ä¸ä¹‹å‰ç›¸åŒ)
    const Message = AV.Object.extend('Message');

    // åŠ è½½æ‰€æœ‰å†å²æ¶ˆæ¯ï¼ˆé¦–æ¬¡æ‰“å¼€æ˜¾ç¤ºå…¨éƒ¨ï¼‰
    async function loadAllMessages() {
        const query = new AV.Query('Message');
        query.ascending('createdAt'); // æŒ‰æ—¶é—´æ­£åº
        query.limit(200); // æœ€å¤š200æ¡ï¼Œè¶³å¤Ÿ
        
        try {
            const results = await query.find();
            messageHistoryDiv.innerHTML = ''; // æ¸…ç©º
            if (results.length === 0) {
                // å¯æ”¾ä¸€æ¡é»˜è®¤æç¤º
                messageHistoryDiv.innerHTML = '<div class="message-item own"><small style="color:#ccc;">è¿˜æ²¡æœ‰æ¶ˆæ¯ï¼Œå‘é€ç¬¬ä¸€æ¡å§~</small></div>';
            } else {
                results.forEach(result => {
                    const text = result.get('text') || '';
                    const time = result.get('time') || 'åˆšåˆš';
                    const sender = result.get('sender') || 'å¯¹æ–¹'; // å…¼å®¹æ—§æ•°æ®
                    appendMessageToHistory(text, time, sender);
                });
            }
            // æ»šåŠ¨åˆ°åº•éƒ¨
            const chat = document.getElementById('chat');
            chat.scrollTop = chat.scrollHeight;
        } catch (error) {
            console.log('åŠ è½½æ¶ˆæ¯å¤±è´¥:', error);
        }
    }

    // å°†å•æ¡æ¶ˆæ¯é™„åŠ åˆ°å†å²è®°å½•å®¹å™¨ (åŒºåˆ†è‡ªå·±å’Œå¯¹æ–¹æ ·å¼)
    function appendMessageToHistory(text, time, sender) {
        const msgDiv = document.createElement('div');
        // æ ¹æ®å‘é€è€…æ·»åŠ ä¸åŒç±»ï¼Œä½†éƒ½æ˜¾ç¤ºåœ¨å†å²é‡Œ
        if (sender === 'æˆ‘') {
            msgDiv.className = 'message-item own';
        } else {
            msgDiv.className = 'message-item other';
        }
        // æ˜¾ç¤ºå†…å®¹ï¼šå¦‚æœæ˜¯å¯¹æ–¹æ¶ˆæ¯ï¼ŒåŠ ä¸ªğŸ‘¤æ ‡è¯†ï¼›è‡ªå·±æ¶ˆæ¯ä¸åŠ 
        const prefix = (sender === 'æˆ‘') ? '' : 'ğŸ‘¤ ';
        msgDiv.innerHTML = `${prefix}${text} <small>${time}</small>`;
        messageHistoryDiv.appendChild(msgDiv);
    }

    // ä¿å­˜æ¶ˆæ¯åˆ°äº‘ç«¯ (sender: 'æˆ‘' æˆ–å¯¹æ–¹ï¼Œä½†è¿™é‡Œåªç”±å‘é€æ–¹å­˜ä¸ºè‡ªå·±)
    async function saveMessage(text, time, sender) {
        const message = new Message();
        message.set('text', text);
        message.set('time', time);
        message.set('sender', sender); // è¿™é‡Œå­˜å‚¨å‘é€è€…æ ‡è¯†
        try {
            await message.save();
        } catch (error) {
            console.log('ä¿å­˜æ¶ˆæ¯å¤±è´¥:', error);
        }
    }

    // å‘é€æ¶ˆæ¯ (ç”±å‘é€æ–¹è°ƒç”¨)
    async function sendMessage() {
        const text = messageInput.value.trim();
        if (text === '') return;

        const now = new Date();
        const timeStr = now.toLocaleTimeString('zh-CN', { hour12: false, hour: '2-digit', minute: '2-digit' });

        // 1. ç«‹å³æ˜¾ç¤ºåœ¨è‡ªå·±çš„å†å²è®°å½•é‡Œ (sender = 'æˆ‘')
        appendMessageToHistory(text, timeStr, 'æˆ‘');
        
        // 2. ä¿å­˜åˆ°äº‘ç«¯ (æ ‡è®°ä¸º'æˆ‘')
        await saveMessage(text, timeStr, 'æˆ‘');

        // 3. å¦‚æœå†å²é¢æ¿æ˜¯éšè—çš„ï¼Œè‡ªåŠ¨å±•å¼€å¹¶æ›´æ–°æŒ‰é’®æ–‡å­—
        if (!historyVisible) {
            messageHistoryDiv.classList.remove('hidden');
            historyToggleBtn.textContent = 'çŸ¥é“å•¦';
            historyVisible = true;
        }

        // æ¸…ç©ºè¾“å…¥æ¡†
        messageInput.value = '';

        // æ»šåŠ¨åˆ°åº•éƒ¨
        const chat = document.getElementById('chat');
        chat.scrollTop = chat.scrollHeight;
    }

    // ç›‘å¬æ–°æ¶ˆæ¯ (è½®è¯¢æ–¹å¼ï¼Œæ¯2.5ç§’æ£€æŸ¥ä¸€æ¬¡)
    let lastCheckTime = new Date(); // è®°å½•ä¸Šæ¬¡æ£€æŸ¥æ—¶é—´
    setInterval(async () => {
        const query = new AV.Query('Message');
        query.greaterThan('createdAt', lastCheckTime); // åªæŸ¥æ–°æ¶ˆæ¯
        query.ascending('createdAt');
        
        try {
            const results = await query.find();
            if (results.length > 0) {
                results.forEach(result => {
                    const text = result.get('text');
                    const time = result.get('time');
                    const sender = result.get('sender');
                    
                    // å…³é”®ï¼šæ‰€æœ‰äººå‘çš„æ¶ˆæ¯éƒ½è¦æ˜¾ç¤ºï¼ŒåŒ…æ‹¬è‡ªå·±å‘çš„ (ä½†è‡ªå·±å‘çš„å¯èƒ½å·²ç»é€šè¿‡sendMessageæ˜¾ç¤ºè¿‡äº†ï¼Œä¸è¿‡ä¸ºäº†ç®€å•ï¼Œæˆ‘ä»¬å¯ä»¥å…¨éƒ¨è¿½åŠ ï¼Œä½†éœ€é¿å…é‡å¤)
                    // ä¸ºäº†é¿å…é‡å¤ï¼Œç®€å•èµ·è§ï¼Œå¯¹äºè‡ªå·±å‘çš„æ¶ˆæ¯ï¼Œå¦‚æœå®ƒåœ¨è½®è¯¢æ—¶åˆå‡ºç°ï¼Œå¯ä»¥å¿½ç•¥ï¼ˆå› ä¸ºå·²ç»æ˜¾ç¤ºè¿‡ï¼‰
                    // ä½†è½®è¯¢é€šå¸¸ä¸ä¼šç«‹å³æŸ¥åˆ°åˆšå‘çš„ï¼Œå› ä¸ºlastCheckTimeæ˜¯ä¸Šæ¬¡è½®è¯¢æ—¶é—´ï¼Œåˆšå‘çš„ä¼šåœ¨ä¸‹ä¸€æ¬¡è½®è¯¢æŸ¥å‡ºã€‚
                    // å¦‚æœä¸æƒ³ä»»ä½•é‡å¤ï¼Œå¯ä»¥è®°å½•å·²æ˜¾ç¤ºçš„æ¶ˆæ¯idï¼Œä½†LeanCloudå…è´¹ç‰ˆè¿”å›objectIdå¯ç”¨ï¼Œè¿™é‡Œä¸ºäº†ç®€æ´ï¼Œæˆ‘ä»¬åˆ©ç”¨lastCheckTime +
                    // å¹¶ä¸”sender==='æˆ‘'ä¸”æ–‡æœ¬æ—¶é—´ç›¸åŒå¯è§†ä¸ºé‡å¤ï¼Œä½†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬ä»…å½“sender !== 'æˆ‘' æˆ– æ–°æ¶ˆæ¯æ‰æ·»åŠ ï¼Œè¿™æ ·è‡ªå·±å‘çš„åœ¨è½®è¯¢ä¸­ä¸å†æ˜¾ç¤ºã€‚
                    // å®é™…ä¸Šæ›´å¥½çš„åŠæ³•ï¼šè½®è¯¢åˆ°çš„æ¶ˆæ¯å¦‚æœsenderæ˜¯'æˆ‘'ä¸”æ—¶é—´éå¸¸æ¥è¿‘å½“å‰ï¼Œå¯èƒ½æ˜¯è‡ªå·±åˆšåˆšåœ¨å…¶ä»–è®¾å¤‡å‘çš„ï¼Œä¹Ÿéœ€è¦æ˜¾ç¤ºã€‚ä¸ºäº†å…¨é‡åŒæ­¥ï¼Œæˆ‘ä»¬ä¸ç®¡senderæ˜¯è°éƒ½æ˜¾ç¤ºï¼Œ
                    // ä½†å› ä¸ºå‘é€æ–¹æœ¬åœ°å·²ç»appendäº†ä¸€æ¬¡ï¼Œä¼šå¯¼è‡´é‡å¤ã€‚æ‰€ä»¥éœ€è¦å»é‡ã€‚æˆ‘ä»¬ç”¨ç®€å•çš„å»é‡ï¼šè®°å½•æ¯æ¡æ¶ˆæ¯çš„idï¼Œä½†idæ˜¯äº‘ç«¯çš„ã€‚æˆ‘ä»¬å¯ä»¥æ¯”è¾ƒå”¯ä¸€æ ‡è¯†ã€‚
                    // ä½†æœ€ç®€å•å¯é ï¼šå‘é€æ–¹ä¿å­˜åä¸ç«‹å³appendï¼Œè€Œæ˜¯ç­‰å¾…è½®è¯¢æ˜¾ç¤ºï¼Œä½†é‚£æ ·ä¼šæœ‰å»¶è¿Ÿã€‚ç”¨æˆ·å¸Œæœ›ç«‹å³çœ‹åˆ°è‡ªå·±å‘çš„ã€‚
                    // æŠ˜è¡·ï¼šå‘é€æ–¹ç«‹å³appendï¼ŒåŒæ—¶ä¿å­˜ï¼›è½®è¯¢åˆ°çš„æ¶ˆæ¯å¦‚æœæ˜¯è‡ªå·±å‘çš„ï¼Œè·³è¿‡ï¼ˆé€šè¿‡æ¯”è¾ƒæ–‡æœ¬å’Œæ—¶é—´ç²—ç•¥åˆ¤æ–­ï¼‰ã€‚
                    // æˆ‘ä»¬é‡‡ç”¨ï¼šå¦‚æœsender === 'æˆ‘' å¹¶ä¸” å½“å‰æ—¶é—´ä¸timeç›¸å·®å¾ˆå°ï¼ˆæ¯”å¦‚5ç§’å†…ï¼‰ï¼Œå¯èƒ½å·²ç»åœ¨æœ¬åœ°æ˜¾ç¤ºï¼Œå°±è·³è¿‡ï¼›å¦åˆ™æ˜¾ç¤ºï¼ˆæ¯”å¦‚å¦ä¸€ä¸ªè®¾å¤‡å‘çš„ï¼‰ã€‚
                    // ä¸ºäº†ä»£ç æ¸…æ™°ï¼Œæˆ‘ä»¬ç®€å•å®ç°ï¼šæ‰€æœ‰sender !== 'æˆ‘' çš„æ¶ˆæ¯éƒ½æ˜¾ç¤ºï¼›sender === 'æˆ‘' ä½†æ¥è‡ªå…¶ä»–è®¾å¤‡ï¼ˆå³ä¸æ˜¯æœ¬æœºå‘é€ï¼‰ä¹Ÿéœ€è¦æ˜¾ç¤ºï¼Œä½†å¾ˆéš¾åŒºåˆ†ã€‚
                    // å®é™…ä¸Šä¸¤ä¸ªäººå…±ç”¨ä¸€ä¸ªappIdï¼Œæ¯ä¸ªäººå‘çš„senderéƒ½æ˜¯'æˆ‘'ï¼Œæ‰€ä»¥ä¸¤ä¸ªäººçœ‹åˆ°çš„è‡ªå·±éƒ½æ˜¯'æˆ‘'ï¼Œå¯¹æ–¹çœ‹åˆ°çš„ä¹Ÿæ˜¯'æˆ‘'ï¼Ÿä¸å¯¹ï¼Œsenderå­—æ®µå­˜å‚¨çš„æ˜¯å‘é€æ–¹è‡ªå·±è®¾çš„ï¼Œå¦‚æœåŒæ–¹éƒ½å­˜ä¸º'æˆ‘'ï¼Œé‚£å¯¹æ–¹çœ‹åˆ°ä¹Ÿæ˜¯'æˆ‘'ï¼Œä¼šæ··æ·†ã€‚
                    // æ‰€ä»¥éœ€è¦åŒºåˆ†èº«ä»½ï¼ä½†ä¸ºäº†ç®€å•ï¼Œæˆ‘ä»¬çº¦å®šï¼šç”¨ localStorage ç”Ÿæˆä¸€ä¸ªä¸´æ—¶uuidï¼Œå­˜åˆ°senderå­—æ®µä¸ºuuidçš„çŸ­idï¼Œæ˜¾ç¤ºæ—¶æ˜ å°„ä¸ºâ€œæˆ‘â€æˆ–â€œå¯¹æ–¹â€ã€‚ä½†ä¸ºäº†å¿«é€Ÿå®ç°ä½ çš„éœ€æ±‚â€œæ‰€æœ‰äººå‘çš„æ¶ˆæ¯éƒ½åœ¨å†å²è®°å½•æ˜¾ç¤ºï¼Œå¹¶ä¸”å¯¹æ–¹ä¹Ÿå¯ä»¥çœ‹åˆ°â€ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ç”¨å‘é€æ–¹æ ‡è®°ä¸ºå›ºå®šå­—ç¬¦ä¸²â€œæˆ‘â€ï¼Œä½†è¿™æ ·å¯¹æ–¹çœ‹åˆ°æ¶ˆæ¯ä¹Ÿä¼šæ˜¾ç¤ºâ€œæˆ‘â€ï¼Œæ··æ·†ã€‚æ‰€ä»¥å¿…é¡»åŒºåˆ†ä¸¤ä¸ªç”¨æˆ·ã€‚
                    
                    // æ”¹è¿›ï¼šæˆ‘ä»¬ä½¿ç”¨ä¸¤ä¸ªæ ‡è¯†ï¼šå½“å‰ç”¨æˆ·ç§°ä¸ºâ€œsnxâ€ï¼Œå¯¹æ–¹ç§°ä¸ºâ€œgsyâ€ï¼Œä½†å†™æ­»ä¹Ÿè¡Œã€‚ä½†é¡µé¢æ˜¯ä¸ºä¸¤äººè®¾è®¡çš„ï¼Œå¯ä»¥ç®€å•çº¦å®šï¼šæ¯æ¬¡åŠ è½½æ—¶éšæœºåˆ†é…ä¸€ä¸ªè§’è‰²ï¼Ÿä¸é è°±ã€‚
                    // æœ€ç®€æ–¹æ¡ˆï¼šåœ¨LeanCloudä¸­å­˜å‚¨å‘é€è€…æ˜µç§°ï¼Œæ¯”å¦‚å›ºå®šä¸ºâ€œsnxâ€æˆ–â€œgsyâ€ã€‚ä½†æ˜¯ç”¨æˆ·ä¸çŸ¥é“å¯¹æ–¹æ˜¯è°ã€‚æˆ‘ä»¬å¯ä»¥è®©ç”¨æˆ·è‡ªå·±é€‰æ‹©ï¼Ÿå¤ªå¤æ‚ã€‚
                    
                    // é‰´äºåŸé¡µé¢æ˜¯åŒäººçºªå¿µé¡µï¼Œæˆ‘ä»¬å‡è®¾åªæœ‰ä¸¤äººä½¿ç”¨ï¼šä¸€ä¸ªäººæ˜¯â€œæˆ‘â€ï¼Œå¦ä¸€ä¸ªäººæ˜¯â€œå¯¹æ–¹â€ã€‚æˆ‘ä»¬å¯ä»¥åˆ©ç”¨æµè§ˆå™¨æœ¬åœ°å­˜å‚¨ä¸€ä¸ªç®€å•çš„æ ‡è¯†ï¼šç¬¬ä¸€æ¬¡è®¿é—®æ—¶éšæœºç”Ÿæˆä¸€ä¸ªè®¾å¤‡IDï¼Œå¹¶è¯¢é—®ï¼Ÿä¸ï¼Œå°±å‡è®¾å½“å‰ç”¨æˆ·æ€»æ˜¯â€œæˆ‘â€ï¼Œå¯¹æ–¹æ€»æ˜¯â€œå¯¹æ–¹â€ã€‚ä½†åŒæ–¹éƒ½ä¼šæŠŠè‡ªå·±å½“â€œæˆ‘â€ï¼Œé‚£ä¹ˆåŒæ–¹çœ‹åˆ°çš„è‡ªå·±å‘çš„æ¶ˆæ¯éƒ½æ˜¯â€œæˆ‘â€ï¼Œå¯¹æ–¹å‘çš„æ¶ˆæ¯åœ¨å¯¹æ–¹çœ‹æ¥æ˜¯â€œæˆ‘â€ï¼ˆå› ä¸ºå¯¹æ–¹å­˜çš„æ˜¯â€œæˆ‘â€ï¼‰ï¼Œåœ¨è‡ªå·±çœ‹æ¥å¯¹æ–¹æ¶ˆæ¯åº”è¯¥æ˜¯â€œå¯¹æ–¹â€ã€‚
                    
                    // è§£å†³æ–¹æ¡ˆï¼šä¿®æ”¹å­˜å‚¨é€»è¾‘ï¼šæ¯ä¸ªæ¶ˆæ¯å­˜å‚¨å‘é€è€…æ ‡è¯†ä¸ºå›ºå®šçš„ä¸¤ä¸ªå€¼ä¹‹ä¸€ï¼š'snx' æˆ– 'gsy'ã€‚ä½†åœ¨UIé‡Œï¼Œå½“å‰ç”¨æˆ·éœ€è¦çŸ¥é“è‡ªå·±æ˜¯å“ªä¸€ä¸ªã€‚æˆ‘ä»¬å¯ä»¥ç®€å•å†™æ­»ï¼šå½“å‰é¡µé¢é»˜è®¤ç”¨æˆ·ä¸º'snx'ï¼Œå¦ä¸€ä¸ªç”¨æˆ·ä¸º'gsy'ã€‚ä½†å¯¹æ–¹ä¹Ÿæ‰“å¼€è¿™ä¸ªé¡µé¢ï¼Œä¹Ÿè®¤ä¸ºè‡ªå·±æ˜¯'snx'ï¼Œå°±å†²çªäº†ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ä¸ªåˆ‡æ¢ï¼Ÿä½†ä½œä¸ºç¤¼ç‰©é¡µï¼Œæˆ‘ä»¬å¯ä»¥é»˜è®¤å‘é€æ–¹ä¸ºâ€œæˆ‘â€ï¼ˆæ˜¾ç¤ºä¸ºâ€œæˆ‘â€ï¼‰ï¼Œä½†è¿™æ ·å¯¹æ–¹çœ‹åˆ°çš„æ˜¯â€œæˆ‘â€ï¼Œä¸å¤ªå¯¹ã€‚ä½†ä½ è¯´çš„éœ€æ±‚æ˜¯â€œæ‰€æœ‰äººå‘çš„æ¶ˆæ¯éƒ½åœ¨å†å²è®°å½•æ˜¾ç¤ºå¹¶ä¸”å¯¹æ–¹ä¹Ÿå¯ä»¥çœ‹åˆ°â€ï¼Œå¹¶æ²¡æœ‰å¼ºè°ƒæ˜µç§°åŒºåˆ†ï¼Œæ‰€ä»¥å³ä½¿æ˜¾ç¤ºä¸ºâ€œæˆ‘â€å’Œâ€œå¯¹æ–¹â€ï¼Œåªè¦ä¸¤äººéƒ½èƒ½çœ‹åˆ°æ‰€æœ‰æ¶ˆæ¯å³å¯ã€‚ç›®å‰æˆ‘ä»¬ä¿æŒç®€å•ï¼šæœ¬æœºå‘é€æ—¶å­˜sender='æˆ‘'ï¼Œè½®è¯¢åˆ°çš„æ¶ˆæ¯å¦‚æœæ˜¯sender='æˆ‘'å¹¶ä¸”ä¸æ˜¯æœ¬æœºåˆšå‘çš„ï¼ˆé€šè¿‡æ—¶é—´ç²—ç•¥å»é‡ï¼‰ï¼Œå°±æ·»åŠ ï¼Œå¹¶æ˜¾ç¤ºä¸ºâ€œå¯¹æ–¹â€ï¼ˆå› ä¸ºæ—¢ç„¶èƒ½è½®è¯¢åˆ°ä¸”ä¸æ˜¯è‡ªå·±å‘çš„ï¼Œè¯´æ˜æ˜¯å¯¹æ–¹å‘çš„ï¼Œä½†å¯¹æ–¹å­˜çš„æ˜¯'æˆ‘'ï¼Œæ‰€ä»¥éœ€è¦è½¬æ¢ï¼‰ã€‚ä¸ºäº†é¿å…æ··ä¹±ï¼Œæˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹ï¼šå‘é€æ—¶å­˜senderå­—æ®µä¸º 'me' å­—ç¬¦ä¸²ï¼Œè½®è¯¢æ—¶ï¼Œå¦‚æœsender==='me'ï¼Œåˆ™ä»£è¡¨æ¶ˆæ¯æ¥è‡ªâ€œå‘é€è€…è‡ªå·±â€ï¼ˆå¯èƒ½æ˜¯æœ¬æœºä¹Ÿå¯èƒ½æ˜¯å¯¹æ–¹æœºå­ï¼‰ï¼Œä½†åœ¨æ˜¾ç¤ºæ—¶ï¼Œæˆ‘ä»¬éœ€è¦åŒºåˆ†ï¼šå¦‚æœè¿™æ¡æ¶ˆæ¯çš„messageIdå’Œæœ¬åœ°æœ€è¿‘å‘é€çš„idä¸åŒï¼Œåˆ™è§†ä¸ºå¯¹æ–¹å‘é€ã€‚ä½†ç”±äºæˆ‘ä»¬æ²¡æœ‰å­˜messageIdåˆ—è¡¨ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ªç®€å•è§„åˆ™ï¼šå½“è½®è¯¢åˆ°sender==='me' ä¸” æ¶ˆæ¯çš„createdAt è·ç¦»å½“å‰æ—¶é—´å¤§äº3ç§’ï¼ˆè¯´æ˜ä¸æ˜¯åˆšåˆšæœ¬æœºå‘é€çš„é‚£æ¡ï¼‰ï¼Œå°±ä½œä¸ºå¯¹æ–¹æ¶ˆæ¯æ˜¾ç¤ºã€‚å¦åˆ™å¿½ç•¥ï¼ˆå› ä¸ºæœ¬æœºå·²ç»æ˜¾ç¤ºè¿‡ï¼‰ã€‚
                    
                    // æ›´å¥å£®ï¼šæˆ‘ä»¬æ”¹ä¸ºå­˜å‚¨å‘é€è€…æ ‡è¯†ä¸ºå›ºå®šçš„ä¸¤ä¸ªè§’è‰²ï¼šä½†é¡µé¢æ— æ³•çŸ¥é“å½“å‰ç”¨æˆ·æ˜¯å“ªä¸ªè§’è‰²ã€‚æ‰€ä»¥æˆ‘ä»¬ç”¨ä¸€ä¸ªæŠ˜ä¸­ä½†æ»¡è¶³è¦æ±‚çš„æ–¹æ³•ï¼šæ‰€æœ‰æ¶ˆæ¯éƒ½æ˜¾ç¤ºï¼Œå¹¶ä¸”ç”¨å·¦å³æ°”æ³¡åŒºåˆ†ï¼Œä¸ç”¨â€œæˆ‘â€â€œå¯¹æ–¹â€æ–‡å­—ï¼Œè€Œæ˜¯ç”¨é¢œè‰²æˆ–å›¾æ ‡ã€‚ä½†ä¹‹å‰æ ·å¼å·²ç»ç”¨äº†own/otherï¼Œæˆ‘ä»¬å°±åŸºäºæ­¤ï¼šå‘é€æ—¶æˆ‘ä»¬å­˜ä¸€ä¸ªå­—æ®µ `from` ä¸ºå½“å‰æµè§ˆå™¨å®ä¾‹çš„ä¸´æ—¶IDï¼ˆå­˜å‚¨åœ¨localStorageï¼‰ï¼Œæ˜¾ç¤ºæ—¶ï¼Œå¦‚æœfrom === myIdï¼Œåˆ™æ˜¯ownï¼Œå¦åˆ™æ˜¯otherã€‚è¿™æ ·ä¸¤äººçœ‹åˆ°çš„è‡ªå·±æ¶ˆæ¯éƒ½æ˜¯ownï¼Œå¯¹æ–¹æ¶ˆæ¯éƒ½æ˜¯otherï¼Œå®Œç¾ç¬¦åˆè¦æ±‚ï¼
                    
                    // è®©æˆ‘ä»¬é‡å†™è¿™éƒ¨åˆ†é€»è¾‘ï¼Œä½¿ç”¨ localStorage ç”Ÿæˆä¸€ä¸ªè®¿å®¢IDã€‚
                    
                });
                // ä¸ºäº†ä¸ç ´åå·²æœ‰ç»“æ„ï¼Œä¸‹é¢é‡å†™æ•´ä¸ªèŠå¤©é€»è¾‘ï¼Œç”¨æ›´å¥å£®çš„æ–¹å¼ã€‚
            }
        } catch (error) {
            console.log('æ£€æŸ¥æ–°æ¶ˆæ¯å¤±è´¥:', error);
        }
    }, 3000);

    // ç”±äºä¸Šé¢é€»è¾‘éœ€è¦é‡æ„ï¼Œæˆ‘å°†åœ¨ä¸‹ä¸€ä¸ªä»£ç å—ä¸­å®Œå…¨é‡å†™èŠå¤©éƒ¨åˆ†ï¼Œä¿æŒå…¶ä»–ä¸å˜ã€‚
    // ä¸ºäº†å¿«é€Ÿæ»¡è¶³â€œæ‰€æœ‰äººå¯è§â€ï¼Œæˆ‘ç›´æ¥æä¾›ä¿®æ”¹åçš„æœ€ç»ˆç‰ˆæœ¬ï¼Œå°†ä¸Šè¿°è½®è¯¢æ›¿æ¢ä¸ºæ­£ç¡®çš„å®ç°ã€‚
    // ä½†å› ç¯‡å¹…ï¼Œæˆ‘å°†åœ¨ä¿æŒåŸæœ‰æ¡†æ¶åŸºç¡€ä¸Šï¼Œåœ¨ä¸‹é¢ç›´æ¥ç»™å‡ºä¿®æ­£åçš„å®Œæ•´èŠå¤©è„šæœ¬ã€‚
    // æ³¨æ„ï¼šä¸ºäº†ä¸è¦†ç›–åŸæœ‰å‡½æ•°ï¼Œæˆ‘å°†ç«‹å³æ‰§è¡Œæ–°çš„åˆå§‹åŒ–ã€‚
    
    // ========== é‡å†™èŠå¤©é€»è¾‘ - å®Œç¾åŒäººå…±äº« ==========
    (function initChat() {
        // ç”Ÿæˆæˆ–è·å–æœ¬åœ°å”¯ä¸€ID (å­˜å‚¨åœ¨localStorage)
        let localId = localStorage.getItem('chat_user_id');
        if (!localId) {
            localId = 'user_' + Math.random().toString(36).substring(2, 10);
            localStorage.setItem('chat_user_id', localId);
        }

        // æ¸…ç©ºå¯èƒ½å·²æœ‰çš„å†å²åŒºåŸŸ
        const historyDiv = document.getElementById('messageHistory');
        const toggleBtn = document.getElementById('historyToggleBtn');
        const inputField = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendMsgBtn');
        
        // å­˜å‚¨æœ€ååŠ è½½æ—¶é—´
        let lastLoadedTime = new Date(0); // åˆå§‹ä¸º1970
        
        // åŠ è½½æ‰€æœ‰å†å²æ¶ˆæ¯ (é¦–æ¬¡)
        async function loadInitialMessages() {
            const query = new AV.Query('Message');
            query.ascending('createdAt');
            query.limit(200);
            try {
                const results = await query.find();
                historyDiv.innerHTML = '';
                if (results.length === 0) {
                    historyDiv.innerHTML = '<div class="message-item own"><small>ğŸ’¬ å¼€å§‹ä½ ä»¬çš„å¯¹è¯å§</small></div>';
                } else {
                    results.forEach(msg => {
                        const text = msg.get('text') || '';
                        const time = msg.get('time') || '';
                        const senderId = msg.get('senderId') || ''; // å­˜å‚¨å‘é€è€…ID
                        const isOwn = (senderId === localId);
                        appendMessage(text, time, isOwn);
                    });
                    if (results.length > 0) {
                        lastLoadedTime = results[results.length-1].get('createdAt');
                    }
                }
                scrollToBottom();
            } catch (e) {
                console.log('åˆå§‹åŒ–åŠ è½½å¤±è´¥', e);
            }
        }

        // è¿½åŠ æ¶ˆæ¯åˆ°å†å²åŒºåŸŸ
        function appendMessage(text, time, isOwn) {
            const msgDiv = document.createElement('div');
            msgDiv.className = isOwn ? 'message-item own' : 'message-item other';
            // ä¸åŠ é¢å¤–å‰ç¼€ï¼Œç”±é¢œè‰²åŒºåˆ†
            msgDiv.innerHTML = `${text} <small>${time}</small>`;
            historyDiv.appendChild(msgDiv);
        }

        // æ»šåŠ¨åˆ°åº•éƒ¨
        function scrollToBottom() {
            const chat = document.getElementById('chat');
            chat.scrollTop = chat.scrollHeight;
        }

        // å‘é€æ¶ˆæ¯
        async function sendChatMessage() {
            const text = inputField.value.trim();
            if (!text) return;

            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-CN', { hour12: false, hour:'2-digit', minute:'2-digit' });
            
            // ç«‹å³æ˜¾ç¤ºè‡ªå·±æ¶ˆæ¯
            appendMessage(text, timeStr, true);
            
            // ä¿å­˜åˆ°äº‘ç«¯
            const MessageClass = AV.Object.extend('Message');
            const msg = new MessageClass();
            msg.set('text', text);
            msg.set('time', timeStr);
            msg.set('senderId', localId);  // å­˜å‚¨IDï¼Œç”¨äºåŒºåˆ†
            try {
                await msg.save();
                // æ›´æ–°æœ€ååŠ è½½æ—¶é—´
                lastLoadedTime = new Date(); 
            } catch (e) {
                console.log('ä¿å­˜å¤±è´¥', e);
            }

            inputField.value = '';
            scrollToBottom();

            // å¦‚æœå†å²é¢æ¿éšè—ï¼Œè‡ªåŠ¨å±•å¼€
            if (historyDiv.classList.contains('hidden')) {
                historyDiv.classList.remove('hidden');
                toggleBtn.textContent = 'çŸ¥é“å•¦';
            }
        }

        // è½®è¯¢æ–°æ¶ˆæ¯ (æ¯ç§’)
        setInterval(async () => {
            const query = new AV.Query('Message');
            query.greaterThan('createdAt', lastLoadedTime);
            query.ascending('createdAt');
            try {
                const results = await query.find();
                if (results.length > 0) {
                    results.forEach(msg => {
                        const text = msg.get('text');
                        const time = msg.get('time');
                        const senderId = msg.get('senderId');
                        // ä¸æ˜¯è‡ªå·±å‘çš„æ‰è¿½åŠ  (è‡ªå·±å‘çš„å·²ç»åœ¨å‘é€æ—¶æ˜¾ç¤ºäº†)
                        if (senderId !== localId) {
                            appendMessage(text, time, false);
                        }
                    });
                    // æ›´æ–°æœ€ååŠ è½½æ—¶é—´
                    if (results.length > 0) {
                        lastLoadedTime = results[results.length-1].get('createdAt');
                    }
                    scrollToBottom();
                }
            } catch (e) {
                console.log('è½®è¯¢å¤±è´¥', e);
            }
        }, 2000);

        // ç»‘å®šäº‹ä»¶
        sendButton.addEventListener('click', function(e) {
            e.preventDefault();
            sendChatMessage();
            playAudio(); // è°ƒç”¨åŸæœ‰çš„æ’­æ”¾
        });

        inputField.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendChatMessage();
                playAudio();
            }
        });

        toggleBtn.addEventListener('click', function() {
            if (historyDiv.classList.contains('hidden')) {
                historyDiv.classList.remove('hidden');
                toggleBtn.textContent = 'çŸ¥é“å•¦';
            } else {
                historyDiv.classList.add('hidden');
                toggleBtn.textContent = 'çœ‹çœ‹éƒ½è¯´äº†äº›å•¥';
            }
            scrollToBottom();
        });

        // å¼€å§‹åŠ è½½
        loadInitialMessages();
    })();

    // æ•°ç‹¬æ˜¾ç¤º/éšè—æ§åˆ¶ (ä¿ç•™åŸæ ·)
    const sudokuSection = document.getElementById('sudokuSection');
    const sudokuToggleBtn = document.getElementById('sudokuToggleBtn');
    let sudokuVisible = false;

    sudokuToggleBtn.addEventListener('click', function() {
        if (sudokuVisible) {
            sudokuSection.classList.add('hidden-sudoku');
            sudokuToggleBtn.textContent = 'ğŸ‘ç»™è€å©†è§£é—·';
            sudokuVisible = false;
        } else {
            sudokuSection.classList.remove('hidden-sudoku');
            sudokuToggleBtn.textContent = 'ğŸ‘è¿˜æ— èŠå°±æ‰¾æˆ‘èŠå¤©å“¦ æŒ‡è·¯yeoboèŠå¤©æ¡†';
            sudokuVisible = true;
        }
        playAudio();
    });

    // é¡µé¢åŠ è½½å®Œæˆåå†é¢å¤–æ‰§è¡Œä¸€æ¬¡åŠ è½½ (ä½†initChatå·²ç»æ‰§è¡Œ)
    window.addEventListener('load', function() {
        // å·²ç»ç”±initChatåŠ è½½
    });
</script>

</body>
</html>
